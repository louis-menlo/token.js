var ke=Object.create;var ne=Object.defineProperty;var Se=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var be=Object.getPrototypeOf,Ie=Object.prototype.hasOwnProperty;var Ae=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var Oe=(t,e,o,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Re(e))!Ie.call(t,s)&&s!==o&&ne(t,s,{get:()=>e[s],enumerable:!(n=Se(e,s))||n.enumerable});return t};var Ee=(t,e,o)=>(o=t!=null?ke(be(t)):{},Oe(e||!t||!t.__esModule?ne(o,"default",{value:t,enumerable:!0}):o,t));var xe=Ae((I,ye)=>{"use strict";var Tt=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},k=Tt();ye.exports=I=k.fetch;k.fetch&&(I.default=k.fetch.bind(k));I.Headers=k.Headers;I.Request=k.Request;I.Response=k.Response});import Ft from"chalk";import{lookup as Wt}from"mime-types";var eo={models:"Model",supportsCompletion:"Chat Completion",supportsStreaming:"Streaming",supportsJSON:"JSON Output",supportsImages:"Image Input",supportsToolCalls:"Function Calling",supportsN:"N > 1"},m={openai:{models:["gpt-4.5-preview","gpt-4.5-preview-2025-02-27","gpt-4.1","gpt-4.1-2025-04-14","gpt-4o","gpt-4o-mini","gpt-4o-2024-05-13","gpt-4o-2024-08-06","gpt-4-turbo","gpt-4-turbo-2024-04-09","gpt-4-0125-preview","gpt-4-turbo-preview","gpt-4-1106-preview","gpt-4-vision-preview","gpt-4","gpt-4-0314","gpt-4-0613","gpt-4-32k","gpt-4-32k-0314","gpt-4-32k-0613","gpt-3.5-turbo","gpt-3.5-turbo-16k","gpt-3.5-turbo-0301","gpt-3.5-turbo-0613","gpt-3.5-turbo-1106","gpt-3.5-turbo-0125","gpt-3.5-turbo-16k-0613","o3-mini","o1-mini","o1-mini-2024-09-12","o1-preview","o1-preview-2024-09-12"],supportsCompletion:!0,supportsStreaming:["gpt-4.1","gpt-4.1-2025-04-14","gpt-4.5-preview","gpt-4.5-preview-2025-02-27","gpt-4o","gpt-4o-mini","gpt-4o-2024-05-13","gpt-4o-2024-08-06","gpt-4-turbo","gpt-4-turbo-2024-04-09","gpt-4-0125-preview","gpt-4-turbo-preview","gpt-4-1106-preview","gpt-4-vision-preview","gpt-4","gpt-4-0314","gpt-4-0613","gpt-4-32k","gpt-4-32k-0314","gpt-4-32k-0613","gpt-3.5-turbo","gpt-3.5-turbo-16k","gpt-3.5-turbo-0301","gpt-3.5-turbo-0613","gpt-3.5-turbo-1106","gpt-3.5-turbo-0125","gpt-3.5-turbo-16k-0613","o3-mini"],supportsJSON:["gpt-4.1","gpt-4.1-2025-04-14","gpt-4.5-preview","gpt-4.5-preview-2025-02-27","gpt-4o","gpt-4o-mini","gpt-4o-2024-05-13","gpt-4o-2024-08-06","gpt-4-turbo","gpt-4-turbo-2024-04-09","gpt-4-0125-preview","gpt-4-turbo-preview","gpt-4-1106-preview","gpt-4-vision-preview","gpt-3.5-turbo","gpt-3.5-turbo-1106","gpt-3.5-turbo-0125","o3-mini"],supportsImages:["gpt-4.1","gpt-4.1-2025-04-14","gpt-4.5-preview","gpt-4.5-preview-2025-02-27","gpt-4o","gpt-4o-mini","gpt-4o-2024-05-13","gpt-4o-2024-08-06","gpt-4-turbo","gpt-4-turbo-2024-04-09","gpt-4-0125-preview","gpt-4-turbo-preview","gpt-4-1106-preview","gpt-4-vision-preview"],supportsToolCalls:["gpt-4.1","gpt-4.1-2025-04-14","gpt-4.5-preview","gpt-4.5-preview-2025-02-27","gpt-4o","gpt-4o-mini","gpt-4o-2024-05-13","gpt-4o-2024-08-06","gpt-4-turbo","gpt-4-turbo-2024-04-09","gpt-4-turbo-preview","gpt-4-0125-preview","gpt-4-1106-preview","gpt-4","gpt-4-0613","gpt-3.5-turbo","gpt-3.5-turbo-0125","gpt-3.5-turbo-1106","gpt-3.5-turbo-0613","o3-mini"],supportsN:!0,generateDocs:!0},ai21:{models:["jamba-instruct"],supportsCompletion:!0,supportsStreaming:["jamba-instruct"],supportsJSON:[],supportsImages:[],supportsToolCalls:[],supportsN:!0,generateDocs:!0},anthropic:{models:["claude-3-7-sonnet-latest","claude-3-7-sonnet-20250219","claude-3-5-sonnet-latest","claude-3-5-sonnet-20240620","claude-3-5-haiku-20241022","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307","claude-2.1","claude-2.0","claude-instant-1.2"],supportsCompletion:!0,supportsStreaming:["claude-3-7-sonnet-latest","claude-3-7-sonnet-20250219","claude-3-5-sonnet-latest","claude-3-5-sonnet-20240620","claude-3-5-haiku-20241022","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307","claude-2.1","claude-2.0","claude-instant-1.2"],supportsJSON:[],supportsImages:["claude-3-7-sonnet-latest","claude-3-7-sonnet-20250219","claude-3-5-sonnet-latest","claude-3-5-sonnet-20240620","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307"],supportsToolCalls:["claude-3-7-sonnet-latest","claude-3-7-sonnet-20250219","claude-3-5-sonnet-latest","claude-3-5-sonnet-20240620","claude-3-5-haiku-20241022","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307"],supportsN:!1,generateDocs:!0},gemini:{models:["gemini-2.0-flash-001","gemini-2.0-flash-lite-preview-02-05","gemini-1.5-pro","gemini-1.5-flash","gemini-1.5-flash-8b","gemini-1.0-pro"],supportsCompletion:!0,supportsStreaming:["gemini-2.0-flash-001","gemini-2.0-flash-lite-preview-02-05","gemini-1.5-pro","gemini-1.5-flash","gemini-1.5-flash-8b","gemini-1.0-pro"],supportsJSON:["gemini-2.0-flash-001","gemini-2.0-flash-lite-preview-02-05","gemini-1.5-pro","gemini-1.5-flash","gemini-1.5-flash-8b"],supportsImages:["gemini-2.0-flash-001","gemini-2.0-flash-lite-preview-02-05","gemini-1.5-pro","gemini-1.5-flash","gemini-1.5-flash-8b"],supportsToolCalls:["gemini-2.0-flash-001","gemini-1.5-pro","gemini-1.5-flash","gemini-1.5-flash-8b","gemini-1.0-pro"],supportsN:!0,generateDocs:!0},cohere:{models:["command-r-plus","command-r","command","command-nightly","command-light","command-light-nightly"],supportsCompletion:!0,supportsStreaming:["command-r-plus","command-r","command","command-nightly","command-light","command-light-nightly"],supportsJSON:[],supportsImages:[],supportsToolCalls:["command-r-plus","command-r","command-nightly"],supportsN:!1,generateDocs:!0},bedrock:{models:["amazon.titan-text-lite-v1","amazon.titan-text-express-v1","anthropic.claude-3-5-sonnet-20240620-v1:0","anthropic.claude-3-5-sonnet-20241022-v2:0","anthropic.claude-3-5-haiku-20241022-v1:0","anthropic.claude-3-opus-20240229-v1:0","anthropic.claude-3-sonnet-20240229-v1:0","anthropic.claude-3-haiku-20240307-v1:0","anthropic.claude-v2:1","anthropic.claude-v2","anthropic.claude-instant-v1","cohere.command-r-plus-v1:0","cohere.command-r-v1:0","cohere.command-text-v14","cohere.command-light-text-v14","meta.llama3-8b-instruct-v1:0","meta.llama3-70b-instruct-v1:0","meta.llama2-13b-chat-v1","meta.llama2-70b-chat-v1","mistral.mistral-7b-instruct-v0:2","mistral.mixtral-8x7b-instruct-v0:1","mistral.mistral-large-2402-v1:0"],supportsCompletion:!0,supportsStreaming:["amazon.titan-text-lite-v1","amazon.titan-text-express-v1","anthropic.claude-3-5-sonnet-20240620-v1:0","anthropic.claude-3-5-sonnet-20241022-v2:0","anthropic.claude-3-5-haiku-20241022-v1:0","anthropic.claude-3-opus-20240229-v1:0","anthropic.claude-3-sonnet-20240229-v1:0","anthropic.claude-3-haiku-20240307-v1:0","anthropic.claude-v2:1","anthropic.claude-v2","anthropic.claude-instant-v1","cohere.command-r-plus-v1:0","cohere.command-r-v1:0","cohere.command-text-v14","cohere.command-light-text-v14","meta.llama3-8b-instruct-v1:0","meta.llama3-70b-instruct-v1:0","meta.llama2-13b-chat-v1","meta.llama2-70b-chat-v1","mistral.mistral-7b-instruct-v0:2","mistral.mixtral-8x7b-instruct-v0:1","mistral.mistral-large-2402-v1:0"],supportsJSON:[],supportsImages:["anthropic.claude-3-5-sonnet-20240620-v1:0","anthropic.claude-3-5-sonnet-20241022-v2:0","anthropic.claude-3-sonnet-20240229-v1:0","anthropic.claude-3-opus-20240229-v1:0","anthropic.claude-3-haiku-20240307-v1:0"],supportsToolCalls:["anthropic.claude-3-5-sonnet-20240620-v1:0","anthropic.claude-3-5-sonnet-20241022-v2:0","anthropic.claude-3-5-haiku-20241022-v1:0","anthropic.claude-3-opus-20240229-v1:0","anthropic.claude-3-sonnet-20240229-v1:0","anthropic.claude-3-haiku-20240307-v1:0","cohere.command-r-plus-v1:0","cohere.command-r-v1:0","mistral.mistral-large-2402-v1:0"],supportsN:!1,generateDocs:!0},mistral:{models:["open-mistral-7b","mistral-tiny-2312","open-mixtral-8x7b","mistral-small-2312","open-mixtral-8x22b","open-mixtral-8x22b-2404","mistral-small-latest","mistral-small-2402","mistral-medium-latest","mistral-medium-2312","mistral-large-latest","mistral-large-2402","codestral-latest","codestral-2405","codestral-mamba-2407"],supportsCompletion:!0,supportsStreaming:["open-mistral-7b","mistral-tiny-2312","open-mixtral-8x7b","mistral-small-2312","open-mixtral-8x22b","open-mixtral-8x22b-2404","mistral-small-latest","mistral-small-2402","mistral-medium-latest","mistral-medium-2312","mistral-large-latest","mistral-large-2402","codestral-latest","codestral-2405","codestral-mamba-2407"],supportsJSON:["open-mistral-7b","mistral-tiny-2312","open-mixtral-8x22b","open-mixtral-8x22b-2404","mistral-large-latest","mistral-large-2402","codestral-latest","codestral-2405","codestral-mamba-2407"],supportsImages:[],supportsToolCalls:["open-mixtral-8x22b","open-mixtral-8x22b-2404","mistral-small-latest","mistral-small-2402","mistral-large-latest","mistral-large-2402","codestral-mamba-2407"],supportsN:!1,generateDocs:!0},groq:{models:["llama-3.3-70b-versatile","llama-3.1-8b-instant","llama3-8b-8192","llama3-70b-8192","mixtral-8x7b-32768","gemma-7b-it","gemma2-9b-it"],supportsCompletion:!0,supportsStreaming:["llama-3.3-70b-versatile","llama-3.1-8b-instant","llama3-8b-8192","llama3-70b-8192","mixtral-8x7b-32768","gemma-7b-it","gemma2-9b-it"],supportsJSON:["llama-3.3-70b-versatile","llama-3.1-8b-instant","llama3-70b-8192","gemma-7b-it","gemma2-9b-it"],supportsImages:[],supportsToolCalls:[],supportsN:!1,generateDocs:!0},perplexity:{models:["llama-3.1-sonar-small-128k-online","llama-3.1-sonar-large-128k-online","llama-3.1-sonar-huge-128k-online"],supportsCompletion:!0,supportsStreaming:["llama-3.1-sonar-small-128k-online","llama-3.1-sonar-large-128k-online","llama-3.1-sonar-huge-128k-online"],supportsJSON:[],supportsImages:[],supportsToolCalls:[],supportsN:!1,generateDocs:!0},openrouter:{models:!0,supportsCompletion:!0,supportsStreaming:!0,supportsJSON:!0,supportsImages:!0,supportsToolCalls:!0,supportsN:!0,generateDocs:!1},"openai-compatible":{models:!0,supportsCompletion:!0,supportsStreaming:!0,supportsJSON:!0,supportsImages:!0,supportsToolCalls:!0,supportsN:!0,generateDocs:!1}};var u=class extends Error{constructor(e){super(e),this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor)}},x=class extends Error{constructor(e){super(`${e}
Should never happen. Please report this error to the developers.`),this.name="InvariantError",Error.captureStackTrace(this,this.constructor)}};var g=class{constructor(e,o,n,s,r,a,i){this.opts=e,this.models=o,this.supportsJSON=n,this.supportsImages=s,this.supportsToolCalls=r,this.supportsN=a,this.supportsStreamingMessages=i}validateInputs(e){if(delete e.provider,!this.isSupportedModel(e.model))throw new u(`Invalid 'model' field: ${e.model}.`);if(e.stream&&!this.supportsStreaming(e.model))throw new Error(`Detected 'stream: true', but the following model does not support streaming: ${e.model}`);if(e.tools!==void 0&&!this.supportsTools(e.model))throw new u(`Detected a 'tools' parameter, but the following model does not support tools: ${e.model}`);if(e.tool_choice!==void 0&&!this.supportsTools(e.model))throw new u(`Detected a 'tool_choice' parameter, but the following model does not support tools: ${e.model}`);if(typeof e.temperature=="number"&&e.temperature>2)throw new u(`Expected a temperature less than or equal to 2, but got: ${e.temperature}`);for(let o of e.messages){if(o.role==="function")throw new u("The 'function' role is deprecated. Please use the 'tool' role instead.");if(o.role==="user"&&Array.isArray(o.content)){for(let n of o.content)if(n.type==="image_url"&&!this.supportsImageMessages(e.model))throw new u(`Detected an image in the 'messages' array, but the following model does not support images: ${e.model}`)}}if(typeof e.n=="number"&&e.n>1&&!this.supportsNGreaterThanOne(e.model))throw new u(`The model ${e.model} does not support setting 'n' greater than 1.`);if(e.response_format?.type==="json_object"){if(!this.supportsJSONMode(e.model))throw new u(`The model ${e.model} does not support the 'response_format' type 'json_object'.`);let o=!1;for(let n of e.messages)if(typeof n.content=="string"){if(n.content.toLowerCase().includes("json")){o=!0;break}}else if(Array.isArray(n.content)){for(let s of n.content)if(s.type==="text"&&s.text.toLowerCase().includes("json")){o=!0;break}}if(!o)throw new u("You must include the string 'JSON' somewhere in your prompt when the 'response_format' type is 'json_object'.")}}isSupportedFeature(e,o){return typeof e=="boolean"?e:e.includes(o)}isSupportedModel(e){return this.isSupportedFeature(this.models,e)}supportsJSONMode(e){return this.isSupportedFeature(this.supportsJSON,e)}supportsImageMessages(e){return this.isSupportedFeature(this.supportsImages,e)}supportsNGreaterThanOne(e){return this.isSupportedFeature(this.supportsN,e)}supportsTools(e){return this.isSupportedFeature(this.supportsToolCalls,e)}supportsStreaming(e){return this.isSupportedFeature(this.supportsStreamingMessages,e)}};var Ne=t=>{let e=[],o="user",n=[];for(let s=0;s<t.length;s++){let r=t[s];if(s===0&&r.role==="system")e.push({role:"system",content:_(r.content)});else if(r.role==="user"||r.role==="assistant"||r.role==="system"){let a=r.role==="user"||r.role==="system"?"user":"assistant";if(o!==a&&(e.push({role:o,content:n.join(`
`)}),n=[]),typeof r.content=="string"){let i=r.role==="system"?`System: ${r.content}`:r.content;n.push(i)}else if(Array.isArray(r.content)){let i=r.content.map(p=>{if(p.type==="text")return r.role==="system"?`System: ${p.text}`:p.text;throw new u("AI21 does not support images.")});n.push(...i)}o=a}}return n.length>0&&e.push({role:o,content:n.join(`
`)}),e};async function*Be(t,e,o){let n=t.getReader(),s=new TextDecoder,r="";try{for(;;){let{done:a,value:i}=await n.read();if(a)break;r+=s.decode(i,{stream:!0});let p=r.split(`
`);r=p.pop()||"";for(let l of p){if(l.trim()==="data: [DONE]")return;if(l.trim().startsWith("data:")){let c=JSON.parse(l.replace(/^data:\s*/,"").trim()),d="";for(let h of c.choices)typeof h.delta.content=="string"&&(d+=h.delta.content);let{id:f,choices:v}=c;yield{choices:[{index:0,finish_reason:v[0].finish_reason,logprobs:null,delta:{role:"assistant",content:d}}],id:f,created:o,model:e,object:"chat.completion.chunk"}}}}}finally{n.releaseLock()}}var L=class extends g{validateInputs(e){if(super.validateInputs(e),typeof e.n=="number"&&(e.n>16||e.n<0))throw new u(`AI21 requires that the 'n' parameter is a value between 0 and 16, inclusive. Instead, got: ${e.n}`);if(typeof e.n=="number"&&e.stream===!0&&e.n>1)throw new u(`AI21 requires that 'n' equals '1' when streaming is enabled. Received an 'n' value of: ${e.n}`)}async create(e){this.validateInputs(e);let o=this.opts.apiKey??process.env.AI21_API_KEY;if(o===void 0)throw new u("No AI21 API key detected. Please define an 'AI21_API_KEY' environment variable or supply the API key using the 'apiKey' parameter.");let n=Ne(e.messages),s={max_tokens:e.max_tokens??void 0,messages:n,model:e.model,n:e.n??void 0,stop:e.stop??void 0,temperature:e.temperature??void 0,top_p:e.top_p??void 0,stream:e.stream??void 0},r=P(),a=await fetch("https://api.ai21.com/studio/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);if(e.stream===!0)return Be(a.body,e.model,r);{let i=await a.json();return{choices:i.choices.map(c=>({...c,message:{...c.message,refusal:null},logprobs:null})),id:i.id,usage:i.usage,created:r,model:e.model,object:"chat.completion"}}}};import Le from"@anthropic-ai/sdk";var qe=(t,e,o)=>{let n=De(t.stop_reason),r={index:0,logprobs:null,message:Ke(t.content,t.role,o),finish_reason:n};return{id:t.id,choices:[r],created:e,model:t.model,object:"chat.completion",usage:{prompt_tokens:t.usage.input_tokens,completion_tokens:t.usage.output_tokens,total_tokens:t.usage.input_tokens+t.usage.output_tokens}}};async function*je(t,e){let o,n=null;for await(let s of t){if(s.type==="message_start"&&(o=s.message,yield{choices:[{index:0,finish_reason:se(s.message.stop_reason),logprobs:null,delta:{role:s.message.role}}],created:e,model:o.model,id:o.id,object:"chat.completion.chunk"}),o===void 0)throw new x("Message is undefined.");let r,a={};if(s.type==="content_block_start")s.content_block.type==="text"?a={content:s.content_block.text}:(n===null&&(n=s.index),a={tool_calls:[{index:s.index-n,id:s.content_block.id,type:"function",function:{name:s.content_block.name,arguments:ae(s.content_block.input)?"":JSON.stringify(s.content_block.input)}}]});else if(s.type==="content_block_delta")if(s.delta.type==="input_json_delta"){if(n===null)throw new x("Content block delta event came before a content block start event.");a={tool_calls:[{index:s.index-n,function:{arguments:s.delta.partial_json}}]}}else a={content:s.delta.text};else s.type==="message_delta"&&(r=s.delta.stop_reason);let i=r!==void 0?r:o.stop_reason;yield{choices:[{index:0,finish_reason:se(i),logprobs:null,delta:a}],created:e,model:o.model,id:o.id,object:"chat.completion.chunk"}}}var Ue=t=>t.type==="text",z=t=>t.type==="tool_use",Ke=(t,e,o)=>{let n=t.filter(Ue);n.length>1&&M("Received multiple text blocks from Anthropic, which is unexpected. Concatenating the text blocks into a single string.");let s;if(typeof o!="string"&&o?.type==="function"){let a=t.filter(z).find(i=>i.name===o.function.name);if(!a)throw new x(`Did not receive a tool use block from Anthropic for the function: ${o.function.name}`);s=[a]}else s=t.filter(z);let r;if(s.length>0&&(r=s.map(a=>({id:a.id,function:{name:a.name,arguments:JSON.stringify(a.input)},type:"function"}))),n.length===0){let a=t.every(z)?null:"";return{role:e,refusal:null,content:a,tool_calls:r}}else return{role:e,refusal:null,content:n.map(a=>a.text).join(`
`),tool_calls:r}},De=t=>{if(t===null)throw new x("Detected a 'stop_reason' value of 'null' during a non-streaming call.");return t==="end_turn"||t==="stop_sequence"?"stop":t==="max_tokens"?"length":t==="tool_use"?"tool_calls":"unknown"},$e=(t,e)=>{if(e===void 0||t==="none")return{toolChoice:void 0,tools:void 0};let o=e.map(s=>({name:s.function.name,description:s.function.description,input_schema:{type:"object",...s.function.parameters}})),n;return t===void 0||t==="auto"?n={type:"auto"}:t==="required"?n={type:"any"}:n={type:"tool",name:t.function.name},{toolChoice:n,tools:o}},se=t=>t===null?null:t==="end_turn"||t==="stop_sequence"?"stop":t==="max_tokens"?"length":t==="tool_use"?"tool_calls":"unknown",Je=t=>t==="claude-3-5-sonnet-20240620"||t==="claude-3-opus-20240229"||t==="claude-3-sonnet-20240229"||t==="claude-3-haiku-20240307"||t==="claude-2.1"||t==="claude-2.0"||t==="claude-instant-1.2"?4096:8192,Ge=async t=>{let e=[],o=structuredClone(t),n;o.length>0&&o[0].role==="system"&&(n=_(o[0].content),o.shift()),o[0].role!=="user"&&o[0].role!=="system"&&o.unshift({role:"user",content:"Empty"});let s="user",r=[];for(let a of o){let i=a.role==="user"||a.role==="system"||a.role==="tool"?"user":"assistant";if(s!==i&&(e.push({role:s,content:r}),r=[]),a.role==="tool"){let p={tool_use_id:a.tool_call_id,content:a.content,type:"tool_result"};r.push(p)}else if(a.role==="assistant"){if(typeof a.content=="string"&&r.push({text:a.content,type:"text"}),Array.isArray(a.tool_calls)){let p=a.tool_calls.map(l=>({id:l.id,input:JSON.parse(l.function.arguments),name:l.function.name,type:"tool_use"}));r.push(...p)}}else if(typeof a.content=="string"){let p=a.role==="system"?`System: ${a.content}`:a.content;r.push({type:"text",text:p})}else if(Array.isArray(a.content)){let p=await Promise.all(a.content.map(async l=>{if(l.type==="text")return{type:"text",text:a.role==="system"?`System: ${l.text}`:l.text};{let c=await S(l.image_url.url);return{type:"image",source:{data:c.content,media_type:c.mimeType,type:"base64"}}}}));r.push(...p)}s=i}return r.length>0&&e.push({role:s,content:r}),{messages:e,systemMessage:n}},Fe=t=>{if(t!=null){if(typeof t=="string")return[t];if(Array.isArray(t)&&t.every(e=>typeof e=="string"))return t;throw new Error(`Unknown stop sequence: ${t}`)}},re=t=>t??process.env.ANTHROPIC_API_KEY,q=class extends g{validateInputs(e){super.validateInputs(e);let o=!1;for(let n of e.messages)if(Array.isArray(n.content)){for(let s of n.content)if(s.type==="image_url"&&(s.image_url.detail!==void 0&&s.image_url.detail!=="auto"&&(o=!0),e.model==="claude-instant-1.2"||e.model==="claude-2.0"||e.model==="claude-2.1"))throw new u(`Model '${e.model}' does not support images. Remove any images from the prompt or use Claude version 3 or later.`)}o&&M("Anthropic does not support the 'detail' field for images. The default image quality will be used.")}async create(e){if(this.validateInputs(e),re(this.opts.apiKey)===void 0)throw new u("No Anthropic API key detected. Please define an 'ANTHROPIC_API_KEY' environment variable or supply the API key using the 'apiKey' parameter.");let n=typeof e.stream=="boolean"?e.stream:void 0,s=e.max_tokens??Je(e.model),r=new Le({apiKey:re(this.opts.apiKey),defaultHeaders:{"anthropic-dangerous-direct-browser-access":"true"}}),a=Fe(e.stop),i=typeof e.top_p=="number"?e.top_p:void 0,p=typeof e.temperature=="number"?e.temperature/2:void 0,{messages:l,systemMessage:c}=await Ge(e.messages),{toolChoice:d,tools:f}=$e(e.tool_choice,e.tools);if(n===!0){let v={max_tokens:s,messages:l,model:e.model,stop_sequences:a,temperature:p,top_p:i,stream:n,system:c,tools:f,tool_choice:d},C=P(),h=r.messages.stream(v);return je(h,C)}else{let v={max_tokens:s,messages:l,model:e.model,stop_sequences:a,temperature:p,top_p:i,system:c,tools:f,tool_choice:d},C=P(),h=await r.messages.create(v);return qe(h,C,e.tool_choice)}}};import{BedrockRuntimeClient as We,ConverseCommand as Ye,ConverseStreamCommand as He}from"@aws-sdk/client-bedrock-runtime";var ze=t=>{if(t==="image/gif")return"gif";if(t==="image/jpeg")return"jpeg";if(t==="image/png")return"png";if(t==="image/webp")return"webp";throw new x(`Unsupported MIME type: ${t}`)},Xe=t=>t!=="cohere.command-light-text-v14"&&t!=="cohere.command-text-v14"&&t!=="amazon.titan-text-express-v1"&&t!=="amazon.titan-text-lite-v1"&&t!=="mistral.mistral-7b-instruct-v0:2"&&t!=="mistral.mixtral-8x7b-instruct-v0:1",ie=t=>t!=="cohere.command-light-text-v14"&&t!=="cohere.command-text-v14",Ve=t=>typeof t.text=="string",X=t=>t.toolUse!==void 0,Qe=(t,e)=>{if(t?.message?.content===void 0)return{refusal:null,content:"",role:"assistant"};if(t.message.role==="user")throw new x("Detected a user message in Bedrock's response.");let o=t.message.role??"assistant",n=t.message.content.filter(Ve);n.length>1&&M("Received multiple text blocks from Bedrock, which is unexpected. Concatenating the text blocks into a single string.");let s;if(typeof e!="string"&&e?.type==="function"){let a=t.message.content.filter(X).find(i=>i.toolUse.name===e.function.name);if(!a)throw new x(`Did not receive a tool use block from Bedrock for the function: ${e.function.name}`);s=[a]}else s=t.message.content.filter(X);let r;if(s.length>0&&(r=s.map(a=>{if(a.toolUse.name===void 0)throw new x("Function name is undefined.");return{id:a.toolUse.toolUseId??a.toolUse.name,function:{name:a.toolUse.name,arguments:a.toolUse.input!==void 0?JSON.stringify(a.toolUse.input):""},type:"function"}})),n.length===0){let a=t.message.content.every(X)?null:"";return{role:o,refusal:null,content:a,tool_calls:r}}else{let a=n.map(i=>i.text).join(`
`);return{role:o,refusal:null,content:a,tool_calls:r}}},Ze=async(t,e)=>{let o=(p,l)=>p==="system"?`System: ${l}`:!ie(e)&&p==="assistant"?`Assistant: ${l}`:l,n=[],s=structuredClone(t),r=[];if(Xe(e))for(;s.length>0&&s[0].role==="system";){let p=_(s[0].content);r.push({text:p}),s.shift()}s[0].role!=="user"&&s[0].role!=="system"&&s.unshift({role:"user",content:"Empty"});let a="user",i=[];for(let p of s){let l;if(ie(e)?l=p.role==="user"||p.role==="system"||p.role==="tool"?"user":"assistant":l="user",a!==l&&(n.push({role:a,content:i}),i=[]),p.role==="tool"){let c={toolResult:{toolUseId:p.tool_call_id,content:[{text:_(p.content)}]}};i.push(c)}else if(p.role==="assistant"){if(typeof p.content=="string"){let c=o(p.role,p.content);i.push({text:c})}if(Array.isArray(p.tool_calls)){let c=p.tool_calls?.map(d=>({toolUse:{toolUseId:d.id,input:JSON.parse(d.function.arguments),name:d.function.name}}));i.push(...c)}}else if(typeof p.content=="string"){let c=o(p.role,p.content);i.push({text:c})}else if(Array.isArray(p.content)){let c=await Promise.all(p.content.map(async d=>{if(d.type==="text")return{text:o(p.role,d.text)};{let f=await S(d.image_url.url);return{image:{format:ze(f.mimeType),source:{bytes:Buffer.from(f.content,"base64")}}}}}));i.push(...c)}a=l}return i.length>0&&n.push({role:a,content:i}),{systemMessages:r.length>0?r:void 0,messages:n}},et=t=>{if(t!=null){if(typeof t=="string")return[t];if(Array.isArray(t)&&t.every(e=>typeof e=="string"))return t;throw new Error(`Unknown stop sequence type: ${t}`)}},tt=t=>typeof t.text=="string",ot=t=>t.toolUse!==void 0,nt=(t,e)=>{if(e===void 0||t==="none")return;let o=e.length>0?e.map(s=>{let r=s.function.parameters?{json:s.function.parameters}:void 0;return{toolSpec:{name:s.function.name,description:s.function.description,inputSchema:r}}}):void 0,n;return t===void 0||t==="auto"?n={auto:{}}:t==="required"?n={any:{}}:n={tool:{name:t.function.name}},{toolChoice:n,tools:o}},le=t=>t==="content_filtered"||t==="guardrail_intervened"?"content_filter":t==="end_turn"||t==="stop_sequence"?"stop":t==="max_tokens"?"length":t==="tool_use"?"tool_calls":"unknown";async function*st(t,e,o){let n=t.$metadata.requestId??null;if(t.stream===void 0)yield{id:n,choices:[{index:0,finish_reason:null,logprobs:null,delta:{}}],created:o,model:e,object:"chat.completion.chunk"};else{let s=null;for await(let r of t.stream){if(r.internalServerException)throw r.internalServerException;if(r.modelStreamErrorException)throw r.modelStreamErrorException;if(r.throttlingException)throw r.throttlingException;if(r.validationException)throw r.validationException;let a={};if(r.messageStart){if(r.messageStart.role==="user")throw new x("Received a message from the 'user' role.");a={role:r.messageStart.role}}else if(r.contentBlockStart?.start?.toolUse!==void 0){let l=r.contentBlockStart.contentBlockIndex;if(typeof l!="number")throw new x("Content block index is undefined.");s===null&&(s=l);let c=r.contentBlockStart.start.toolUse.toolUseId??r.contentBlockStart.start.toolUse.name;a={tool_calls:[{index:l-s,id:c,type:"function",function:{name:r.contentBlockStart.start.toolUse.name,arguments:""}}]}}else if(r.contentBlockDelta?.delta!==void 0){if(tt(r.contentBlockDelta.delta))a={content:r.contentBlockDelta.delta.text};else if(ot(r.contentBlockDelta.delta)){let l=r.contentBlockDelta.contentBlockIndex;if(typeof l!="number")throw new x("Content block index is undefined.");if(s===null)throw new x("Content block delta event came before a content block start event.");a={tool_calls:[{index:l-s,function:{arguments:r.contentBlockDelta.delta.toolUse.input}}]}}}let i=typeof r.messageStop?.stopReason=="string"?le(r.messageStop.stopReason):null;yield{id:n,choices:[{index:0,finish_reason:i,logprobs:null,delta:a}],created:o,model:e,object:"chat.completion.chunk"}}}}var j=class extends g{validateInputs(e){super.validateInputs(e);let o=!1;for(let n of e.messages)if(Array.isArray(n.content))for(let s of n.content)s.type==="image_url"&&s.image_url.detail!==void 0&&s.image_url.detail!=="auto"&&(o=!0);o&&M("Bedrock does not support the 'detail' field for images. The default image quality will be used.")}async create(e){this.validateInputs(e),this.opts.baseURL&&M("The 'baseUrl' parameter will be ignored by Bedrock because it does not support this field."),typeof this.opts.apiKey=="string"&&M("The 'apiKey' parameter will be ignored by Bedrock, which uses the 'accessKeyId' and 'secretAccessKey' fields on the 'bedrock' object instead.");let o=this.opts.bedrock?.region??process.env.AWS_REGION_NAME;if(!o)throw new u("No AWS region detected. Please define a region using either the 'region' parameter on the 'bedrock' object or the 'AWS_REGION_NAME' environment variable.");let n=this.opts.bedrock?.accessKeyId??process.env.AWS_ACCESS_KEY_ID,s=this.opts.bedrock?.secretAccessKey??process.env.AWS_SECRET_ACCESS_KEY,r=[];if(n||r.push({envVar:"AWS_ACCESS_KEY_ID",param:"accessKeyId"}),s||r.push({envVar:"AWS_SECRET_ACCESS_KEY",param:"secretAccessKey"}),r.length>0)throw new u(`Missing AWS credentials: ${r.map(w=>w.envVar).join(", ")}. Please define these environment variables or supply them using the following parameters on the 'bedrock' object: ${r.map(w=>w.param).join(", ")}.`);let{systemMessages:a,messages:i}=await Ze(e.messages,e.model),p=typeof e.temperature=="number"?pe(e.temperature,"bedrock",e.model):void 0,l=e.top_p??void 0,c=e.max_tokens??void 0,d=et(e.stop),f=e.model,v=nt(e.tool_choice,e.tools),C={inferenceConfig:{maxTokens:c,stopSequences:d,temperature:p,topP:l},modelId:f,messages:i,system:a,toolConfig:v},h=new We({region:o,credentials:{accessKeyId:n,secretAccessKey:s}});if(e.stream===!0){let w=new He(C),T=P(),y=await h.send(w);return st(y,e.model,T)}else{let w=new Ye(C),T=P(),y=await h.send(w),N=y.usage&&typeof y.usage.inputTokens=="number"&&typeof y.usage.outputTokens=="number"&&typeof y.usage.totalTokens=="number"?{prompt_tokens:y.usage.inputTokens,completion_tokens:y.usage.outputTokens,total_tokens:y.usage.inputTokens+y.usage.outputTokens}:void 0,B=Qe(y.output,e.tool_choice);return{id:y.$metadata.requestId??null,usage:N,choices:[{index:0,logprobs:null,message:B,finish_reason:le(y.stopReason)}],created:T,model:e.model,object:"chat.completion"}}}};import{CohereClient as rt}from"cohere-ai";var me="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var A=(t=21)=>{let e="",o=crypto.getRandomValues(new Uint8Array(t));for(;t--;)e+=me[o[t]&63];return e};var V=t=>{if(t==="assistant")return"CHATBOT";if(t==="system")return"SYSTEM";if(t==="tool")return"TOOL";if(t==="user")return"USER";if(t==="developer")return"SYSTEM";throw new u(`Unknown role: ${t}`)},ue=t=>{if(t==="COMPLETE"||t==="USER_CANCEL"||t==="STOP_SEQUENCE")return"stop";if(t==="MAX_TOKENS")return"length";if(t==="ERROR_TOXIC")return"content_filter";if(t==="ERROR_LIMIT")throw new Error("The generation could not be completed because the model\u2019s context limit was reached.");if(t==="ERROR")throw new Error("The generation could not be completed due to an error.");return"unknown"},at=t=>{for(let e=t.length-1;e>=0;e--){let o=t[e];if(o.role==="user"){if(typeof o.content=="string")return t.splice(e,1),o.content;if(Array.isArray(o.content)){for(let n of o.content)if(n.type==="text")return t.splice(e,1),n.text}}}return"Empty"},it=t=>{if(t!=null){if(typeof t=="string")return[t];if(Array.isArray(t)&&t.every(e=>typeof e=="string"))return t;throw new Error(`Unknown stop sequence type: ${t}`)}},lt=t=>{let e=(r,a,i)=>{switch(r){case"string":return"str";case"integer":return"int";case"array":return`List${a?`[${e(a.type)}]`:""}`;case"object":return i?`Dict[str, ${e(i.type)}]`:"Dict";default:return r}},o=(r,a)=>{let i={};for(let[p,l]of Object.entries(r)){let c=a.includes(p);i[p]={description:l.description,type:e(l.type,l.items,l.additionalProperties),required:c},l.type==="object"&&l.properties&&(i[p].properties=o(l.properties,l.required||[]))}return i},n=Array.isArray(t.function.parameters?.required)?t.function.parameters?.required:[],s=t.function.parameters?.properties?o(t.function.parameters.properties,n):void 0;return{name:t.function.name,description:t.function.description??"",parameterDefinitions:s}},pt=t=>{if(t&&typeof t.inputTokens=="number"&&typeof t.outputTokens=="number"){let{inputTokens:e,outputTokens:o}=t;return{completion_tokens:o,prompt_tokens:e,total_tokens:o+e}}else return},mt=t=>{let e=t.at(t.length-1);if(e===void 0||e.role!=="tool")return;let o=[];for(let n=t.length-1;n>=0;n--){let s=t[n];s.role==="tool"&&(o.unshift(s),t.pop())}return o},ce=(t,e)=>{let o=null;for(let a=e.length-1;a>=0;a--){let i=e[a];if(i.role!=="tool")if(i.role==="assistant"){o=i;break}else throw new Error(`Expected an assistant message to precede tool messages, but detected a message from the ${i.role} role instead.`)}if(o===null)throw new Error("Could not find message from the 'assistant' role, which must precede messages from the 'tool' role.");if(o.tool_calls===void 0)throw new Error("Expected 'assistant' message to contain a 'tool_calls' field because it precedes tool call messages, but no 'tool_calls' field was found.");let n=o.tool_calls.find(a=>a.id===t.tool_call_id);if(!n)throw new Error(`Could not find the following tool call ID in the 'assistant' message: ${t.tool_call_id}`);let s=_(t.content);return{call:{name:n.function.name,parameters:JSON.parse(n.function.arguments)},outputs:[JSON.parse(s)]}},ct=t=>{let e=structuredClone(t),n=mt(e)?.map(a=>ce(a,e)),s=n===void 0?at(e):"",r=[];for(let a=0;a<e.length;a++){let i=e[a];if(i.role==="tool"){let p=ce(i,e.slice(0,a)),l=r.at(r.length-1);if(l!==void 0&&l.role==="TOOL"){if(l.toolResults===void 0)throw new x("The 'toolResults' field is undefined.");l.toolResults.push(p)}else r.push({role:"TOOL",toolResults:[p]})}else if(i.role==="assistant"){let p=_(i.content);r.push({role:V(i.role),message:p,toolCalls:i.tool_calls?.map(l=>({name:l.function.name,parameters:JSON.parse(l.function.arguments)}))})}else if(typeof i.content=="string")r.push({role:V(i.role),message:i.content});else if(Array.isArray(i.content))for(let p of i.content)p.type==="text"&&r.push({role:V(i.role),message:p.text})}return{messages:r,lastUserMessage:s,toolResults:n}},ut=(t,e)=>{if(!(e==="none"||t===void 0))return t.map(lt)};async function*dt(t,e,o){let n,s=new Map;for await(let r of t){if(r.eventType==="stream-start"&&(n=r.generationId,yield{choices:[{index:0,finish_reason:null,logprobs:null,delta:{role:"assistant"}}],created:o,model:e,id:r.generationId,object:"chat.completion.chunk"}),n===void 0)throw new x("The generated ID is undefined.");if(r.eventType==="stream-end")yield{choices:[{index:0,finish_reason:ue(r.finishReason),logprobs:null,delta:{}}],created:o,model:e,id:n,object:"chat.completion.chunk"};else if(r.eventType==="text-generation"||r.eventType==="tool-calls-chunk"&&typeof r.text=="string")yield{choices:[{index:0,finish_reason:null,logprobs:null,delta:{content:r.text}}],created:o,model:e,id:n,object:"chat.completion.chunk"};else if(r.eventType==="tool-calls-chunk"){let a=r.toolCallDelta.index;if(typeof a!="number")throw new x("Content block index is undefined.");let i=s.get(a);i===void 0&&(i=A(),s.set(a,i)),yield{choices:[{index:0,finish_reason:null,logprobs:null,delta:{content:r.toolCallDelta.text,tool_calls:[{index:a,id:i,type:"function",function:{name:r.toolCallDelta.name,arguments:r.toolCallDelta.parameters}}]}}],created:o,model:e,id:n,object:"chat.completion.chunk"}}}}var U=class extends g{async create(e){this.validateInputs(e),this.opts.baseURL&&M("The 'baseUrl' will be ignored by Cohere because it does not support this field.");let o=this.opts.apiKey??process.env.COHERE_API_KEY;if(o===void 0)throw new u("No Cohere API key detected. Please define an 'COHERE_API_KEY' environment variable or supply the API key using the 'apiKey' parameter.");let n=e.max_tokens??void 0,s=e.top_p??void 0,r=it(e.stop),a=typeof e.temperature=="number"?e.temperature/2:void 0,i=ut(e.tools,e.tool_choice),{messages:p,lastUserMessage:l,toolResults:c}=ct(e.messages),d={maxTokens:n,message:l,chatHistory:p,model:e.model,stopSequences:r,temperature:a,p:s,toolResults:c,tools:i},f=new rt({token:o});if(e.stream===!0){let v=P(),C=await f.chatStream(d);return dt(C,e.model,v)}else{let v=P(),C=await f.chat(d),h=C.toolCalls?.map(y=>({type:"function",id:A(),function:{name:y.name,arguments:JSON.stringify(y.parameters)}})),w=pt(C.meta?.billedUnits);return{object:"chat.completion",choices:[{finish_reason:ue(C.finishReason),index:0,logprobs:null,message:{role:"assistant",refusal:null,content:C.text,tool_calls:h}}],created:v,id:C.generationId??null,model:e.model,usage:w}}}};import{FinishReason as R,FunctionCallingMode as b,GoogleGenerativeAI as ft}from"@google/generative-ai";var gt=async(t,e)=>{if(t==null)return[];if(typeof t=="string")return[{text:`${e}${t}`}];{let o=t.map(async n=>{if(n.type==="text")return{text:`${e}${n.text}`};if(n.type==="image_url"){let s=await S(n.image_url.url);return{inlineData:{mimeType:s.mimeType,data:s.content}}}else throw new u(`Invalid content part type: ${n.type}. Must be "text" or "image_url".`)});return Promise.all(o)}},Q=t=>{switch(t){case"assistant":return"model";case"function":case"tool":case"user":case"system":return"user";default:throw new u(`Unexpected message role: ${t}`)}},ht=t=>{let e=t.tool_calls?t.tool_calls.map(o=>({functionCall:{name:o.function.name,args:JSON.parse(o.function.arguments)}})):[];return t.content&&t.content.length&&e.push({text:t.content}),{role:Q(t.role),parts:e}},K=async(t,e)=>{switch(t.role){case"tool":return{role:Q(t.role),parts:[{functionResponse:{name:t.tool_call_id,response:{type:"text",text:_(t.content)}}}]};case"assistant":return ht(t);case"user":case"system":let o=t.role==="system"&&e?`System:
`:"";return{role:Q(t.role),parts:await gt(t.content,o)};default:throw new u(`Unexpected message role: ${t.role}`)}},Ct=async t=>{let e=structuredClone(t),o;if(e.length>0&&e[0].role==="system"){let s=e.shift();o=s!==void 0?await K(s,!1):void 0}let n=[];for(let s of e)if(s.role==="system"||s.role==="user")n.push(await K(s,!0));else if(s.role==="assistant"&&(n.push(await K(s,!0)),s.tool_calls!==void 0))for(let r of s.tool_calls){let a=e.find(i=>i.role==="tool"&&i.tool_call_id===r.id);if(a===void 0)throw new Error(`Could not find tool message with the id: ${r.id}`);n.push(await K(a,!0))}return{contents:n,systemInstruction:o}},de=(t,e)=>{if(e?.some(o=>o.functionCall!==void 0))return"tool_calls";switch(t){case R.STOP:return"stop";case R.MAX_TOKENS:return"length";case R.SAFETY:return"content_filter";case R.OTHER:case R.FINISH_REASON_UNSPECIFIED:case R.RECITATION:return"stop";default:return"stop"}},fe=t=>{let e=t.content?.parts.filter(o=>o.functionCall!==void 0).map((o,n)=>({id:A(),index:n,function:{arguments:JSON.stringify(o.functionCall.args),name:o.functionCall.name},type:"function"}));if(e!==void 0&&e.length>0)return e},yt=t=>fe(t)?.map((e,o)=>({...e,index:o})),xt=t=>({content:t.content?.parts.map(e=>e.text).join("")??null,role:"assistant",tool_calls:fe(t),refusal:null}),ge=t=>({completion_tokens:t.candidatesTokenCount,prompt_tokens:t.promptTokenCount,total_tokens:t.totalTokenCount}),vt=(t,e)=>{if(typeof t=="object")return{functionCallingConfig:{mode:b.ANY,allowedFunctionNames:[t.function.name]}};switch(t){case"auto":return{functionCallingConfig:{mode:b.AUTO}};case"none":return{functionCallingConfig:{mode:b.NONE}};case"required":return{functionCallingConfig:{mode:b.ANY}};default:return{functionCallingConfig:{mode:e&&e?.length>0?b.AUTO:b.NONE}}}},wt=t=>{if(t!==void 0)return t.map(e=>({functionDeclarations:[{name:e.function.name,description:e.function.description,parameters:e.function.parameters}]}))},_t=async(t,e,o)=>({id:null,object:"chat.completion",created:o,model:e,choices:t.response.candidates?.map(n=>({index:n.index,finish_reason:n.finishReason?de(n.finishReason,n.content?.parts):"stop",message:xt(n),logprobs:null}))??[],usage:t.response.usageMetadata?ge(t.response.usageMetadata):void 0});async function*Pt(t,e,o){for await(let n of t.stream){let s=n.text();yield{id:null,object:"chat.completion.chunk",created:o,model:e,choices:n.candidates?.map(r=>({index:r.index,finish_reason:r.finishReason?de(r.finishReason,r.content?.parts):"stop",delta:{content:s,tool_calls:yt(r),role:"assistant"},logprobs:null}))??[],usage:n.usageMetadata?ge(n.usageMetadata):void 0}}}var D=class extends g{async create(e){this.validateInputs(e);let o=this.opts.apiKey??process.env.GEMINI_API_KEY;if(o===void 0)throw new u("API key is required for Gemini, define GEMINI_API_KEY in your environment or specifty the apiKey option.");this.opts.baseURL&&M("The 'baseUrl' will be ignored by Gemini because it does not support this field.");let n=e.response_format?.type==="json_object"?"application/json":void 0,s=typeof e.stop=="string"?[e.stop]:e.stop,a=new ft(o).getGenerativeModel({model:e.model,generationConfig:{maxOutputTokens:e.max_tokens??void 0,temperature:e.temperature??void 0,topP:e.top_p??void 0,stopSequences:s??void 0,candidateCount:e.n??void 0,responseMimeType:n}}),{contents:i,systemInstruction:p}=await Ct(e.messages),l={contents:i,toolConfig:vt(e.tool_choice,e.tools),tools:wt(e.tools),systemInstruction:p},c=P();if(e.stream){let d=await a.generateContentStream(l);return Pt(d,e.model,c)}else{let d=await a.generateContent(l);return _t(d,e.model,c)}}};import Mt from"openai";var $=class extends g{validateInputs(e){if(super.validateInputs(e),e.response_format?.type==="json_object"){if(e.stream)throw new u("Groq does not support streaming when the 'response_format' is 'json_object'.");if(e.stop!==null&&e.stop!==void 0)throw new u("Groq does not support the 'stop' parameter when the 'response_format' is 'json_object'.")}}async create(e){this.validateInputs(e);let o=this.opts.apiKey??process.env.GROQ_API_KEY,n=new Mt({apiKey:o,baseURL:"https://api.groq.com/openai/v1",dangerouslyAllowBrowser:!0});if(o===void 0)throw new u("API key is required for Groq, define GROQ_API_KEY in your environment or specifty the apiKey option.");return n.chat.completions.create(e)}};var Z=class{constructor(e){this.client=e}async create({file:e,purpose:o="fine-tune"}){let n=new FormData;return n.append("file",e),n.append("purpose",o),await this.client._request("post","v1/files",null,void 0,n)}async retrieve({fileId:e}){return await this.client._request("get",`v1/files/${e}`)}async list(){return await this.client._request("get","v1/files")}async delete({fileId:e}){return await this.client._request("delete",`v1/files/${e}`)}},he=Z;var ee=class{constructor(e){this.client=e}async create({model:e,trainingFiles:o,validationFiles:n=[],hyperparameters:s={training_steps:1800,learning_rate:1e-4},suffix:r=null,integrations:a=null}){return await this.client._request("post","v1/fine_tuning/jobs",{model:e,training_files:o,validation_files:n,hyperparameters:s,suffix:r,integrations:a})}async retrieve({jobId:e}){return await this.client._request("get",`v1/fine_tuning/jobs/${e}`,{})}async list(){return await this.client._request("get","v1/fine_tuning/jobs",{})}async cancel({jobId:e}){return await this.client._request("post",`v1/fine_tuning/jobs/${e}/cancel`,{})}},Ce=ee;var kt="0.5.0",St=[429,500,502,503,504],Rt="https://api.mistral.ai",bt=Promise.resolve(globalThis.fetch??Promise.resolve().then(()=>Ee(xe(),1)).then(t=>t.default)),O=class extends Error{constructor(e){super(e),this.name="MistralAPIError"}};function It(t){let e=new AbortController;return t.forEach(o=>{o&&(o.addEventListener("abort",()=>{e.abort(o.reason)},{once:!0}),o.aborted&&e.abort(o.reason))}),e.signal}var te=class{constructor(e=process.env.MISTRAL_API_KEY,o=Rt,n=5,s=120){this.endpoint=o,this.apiKey=e,this.maxRetries=n,this.timeout=s,this.endpoint.indexOf("inference.azure.com")&&(this.modelDefault="mistral"),this.files=new he(this),this.jobs=new Ce(this)}async _fetch(...e){return(await bt)(...e)}_request=async function(e,o,n,s,r=null){let a=`${this.endpoint}/${o}`,i={method:e,headers:{"User-Agent":`mistral-client-js/${kt}`,Accept:n?.stream?"text/event-stream":"application/json","Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},signal:It([AbortSignal.timeout(this.timeout*1e3),s]),body:e!=="get"?r??JSON.stringify(n):null,timeout:this.timeout*1e3};r&&delete i.headers["Content-Type"];for(let p=0;p<this.maxRetries;p++)try{let l=await this._fetch(a,i);if(l.ok){if(n?.stream){if(typeof l.body.getReader>"u")return l.body;{let c=l.body.getReader();return async function*(){try{for(;;){let{done:f,value:v}=await c.read();if(f)return;yield v}}finally{c.releaseLock()}}()}}return await l.json()}else if(St.includes(l.status))console.debug(`Retrying request on response status: ${l.status}`,`Response: ${await l.text()}`,`Attempt: ${p+1}`),await new Promise(c=>setTimeout(c,Math.pow(2,p+1)*500));else throw new O(`HTTP error! status: ${l.status} Response: 
${await l.text()}`)}catch(l){if(console.error(`Request failed: ${l.message}`),l.name==="MistralAPIError"||p===this.maxRetries-1)throw l;await new Promise(c=>setTimeout(c,Math.pow(2,p+1)*500))}throw new Error("Max retries reached")};_makeChatCompletionRequest=function(e,o,n,s,r,a,i,p,l,c,d,f){if(!e&&!this.modelDefault)throw new O("You must provide a model name");return{model:e??this.modelDefault,messages:o,tools:n??void 0,temperature:s??void 0,max_tokens:r??void 0,top_p:a??void 0,random_seed:i??void 0,stream:p??void 0,safe_prompt:(l||c)??void 0,tool_choice:d??void 0,response_format:f??void 0}};_makeCompletionRequest=function(e,o,n,s,r,a,i,p,l){if(!e&&!this.modelDefault)throw new O("You must provide a model name");return{model:e??this.modelDefault,prompt:o,suffix:n??void 0,temperature:s??void 0,max_tokens:r??void 0,top_p:a??void 0,random_seed:i??void 0,stop:p??void 0,stream:l??void 0}};listModels=async function(){return await this._request("get","v1/models")};chat=async function({model:e,messages:o,tools:n,temperature:s,maxTokens:r,topP:a,randomSeed:i,safeMode:p,safePrompt:l,toolChoice:c,responseFormat:d},{signal:f}={}){let v=this._makeChatCompletionRequest(e,o,n,s,r,a,i,!1,p,l,c,d);return await this._request("post","v1/chat/completions",v,f)};chatStream=async function*({model:e,messages:o,tools:n,temperature:s,maxTokens:r,topP:a,randomSeed:i,safeMode:p,safePrompt:l,toolChoice:c,responseFormat:d},{signal:f}={}){let v=this._makeChatCompletionRequest(e,o,n,s,r,a,i,!0,p,l,c,d),C=await this._request("post","v1/chat/completions",v,f),h="",w=new TextDecoder;for await(let T of C){h+=w.decode(T,{stream:!0});let y;for(;(y=h.indexOf(`
`))!==-1;){let N=h.substring(0,y);if(h=h.substring(y+1),N.startsWith("data:")){let B=N.substring(6).trim();B!=="[DONE]"&&(yield JSON.parse(B))}}}};embeddings=async function({model:e,input:o}){let n={model:e,input:o};return await this._request("post","v1/embeddings",n)};completion=async function({model:e,prompt:o,suffix:n,temperature:s,maxTokens:r,topP:a,randomSeed:i,stop:p},{signal:l}={}){let c=this._makeCompletionRequest(e,o,n,s,r,a,i,p,!1);return await this._request("post","v1/fim/completions",c,l)};completionStream=async function*({model:e,prompt:o,suffix:n,temperature:s,maxTokens:r,topP:a,randomSeed:i,stop:p},{signal:l}={}){let c=this._makeCompletionRequest(e,o,n,s,r,a,i,p,!0),d=await this._request("post","v1/fim/completions",c,l),f="",v=new TextDecoder;for await(let C of d){f+=v.decode(C,{stream:!0});let h;for(;(h=f.indexOf(`
`))!==-1;){let w=f.substring(0,h);if(f=f.substring(h+1),w.startsWith("data:")){let T=w.substring(6).trim();T!=="[DONE]"&&(yield JSON.parse(T))}}}}},ve=te;var At=(t,e)=>{for(let o of t)for(let n of o?.tool_calls??[])if(n.id===e)return n.function.name;throw new u(`Tool call with id ${e} not found in messages`)},Ot=t=>t.map(e=>{let o=_(e.content);if(e.role==="tool")return{name:At(t,e.tool_call_id),role:"tool",content:o,tool_call_id:e.tool_call_id};if(e.role==="system")return{role:e.role,content:o};if(e.role==="assistant")return{role:e.role,content:o,tool_calls:e.tool_calls??null};if(e.role==="user"){let n=typeof e.content=="string"?e.content:e.content?.map(s=>s.text);return{role:e.role,content:n}}else throw new Error("Function messages are deprecated.")}),E=(t,e)=>{if(!t)return;let o=t.filter(n=>e===void 0?!0:n.function.name===e);if(e!==void 0&&o.length===0)throw new u(`Tool with name ${e} not found in tool list`);return o.map(n=>({type:"function",function:{name:n.function.name,description:n.function.description??"",parameters:n.function.parameters??{}}}))},Et=(t,e)=>{if(typeof t=="object")return{toolChoice:"any",tools:E(e,t.function.name)};switch(t){case"auto":return{toolChoice:"auto",tools:E(e)};case"none":return{toolChoice:"none",tools:E(e)};case"required":return{toolChoice:"any",tools:E(e)};case void 0:return{toolChoice:void 0,tools:E(e)};default:throw new u(`Invalid tool choice: ${t}`)}},we=t=>{if(t)return t.map(e=>({id:e.id,type:"function",function:{name:e.function.name,arguments:e.function.arguments}}))},Nt=t=>{if(t)return we(t)?.map((e,o)=>({...e,index:o}))};async function*Bt(t){for await(let e of t)yield{id:e.id,created:e.created,object:e.object,model:e.model,choices:e.choices.map(o=>({index:o.index,delta:{role:"assistant",content:o.delta.content,tool_calls:Nt(o.delta.tool_calls)},finish_reason:o.finish_reason,logprobs:null})),usage:e.usage??void 0}}var Lt=t=>({id:t.id,created:t.created,object:t.object,model:t.model,choices:t.choices.map(e=>({index:e.index,message:{role:"assistant",refusal:null,content:e.message.content,tool_calls:we(e.message.tool_calls)},finish_reason:e.finish_reason,logprobs:null})),usage:t.usage}),J=class extends g{async create(e){this.validateInputs(e);let o=this.opts.apiKey??process.env.MISTRAL_API_KEY;if(o===void 0)throw new u("API key is required for Mistral, define MISTRAL_API_KEY in your environment or specifty the apiKey option.");let n=this.opts.baseURL??void 0,s=new ve(o,n),r=e.response_format?.type==="json_object"?{type:"json_object"}:void 0,a=typeof e.temperature=="number"?e.temperature/2:void 0,{toolChoice:i,tools:p}=Et(e.tool_choice,e.tools),l=Ot(e.messages),c={model:e.model,messages:l,temperature:a,maxTokens:e.max_tokens??void 0,topP:e.top_p??void 0,responseFormat:r,toolChoice:i,tools:p};if(e.stream){let d=s.chatStream(c);return Bt(d)}else{let d=await s.chat(c);return Lt(d)}}};import qt from"openai";async function*jt(t){for await(let e of t)yield e}var G=class extends g{constructor(){super(...arguments);this.determineAPIKey=()=>this.opts.apiKey?this.opts.apiKey:process.env.OPENAI_COMPATIBLE_API_KEY?process.env.OPENAI_COMPATIBLE_API_KEY:""}validateInputs(o){if(super.validateInputs(o),!this.opts.baseURL)throw new u("No baseURL option provided for openai compatible provider. You must define a baseURL option to use a generic openai compatible API with Token.js")}async create(o){this.validateInputs(o);let n=this.determineAPIKey(),s=new qt({...this.opts,apiKey:n,dangerouslyAllowBrowser:!0}),r=o;if(delete r.provider,o.stream){let a=await s.chat.completions.create(o);return jt(a)}else return s.chat.completions.create(o)}};import Ut from"openai";async function*Kt(t){for await(let e of t)yield e}var F=class extends g{async create(e){this.validateInputs(e);let o=this.opts.apiKey??process.env.OPENAI_API_KEY,n=new Ut({...this.opts,apiKey:o,dangerouslyAllowBrowser:!0}),s=e;if(delete s.provider,e.stream){let r=await n.chat.completions.create(e);return Kt(r)}else return n.chat.completions.create(e)}};import Dt from"openai";var W=class extends g{validateInputs(e){super.validateInputs(e)}async create(e){this.validateInputs(e),console.log("open router");let o=this.opts.apiKey??process.env.OPENROUTER_API_KEY,n=new Dt({apiKey:o,baseURL:"https://openrouter.ai/api/v1",defaultHeaders:{"HTTP-Referer":"docs.tokenjs.ai","X-Title":"Token.js"},dangerouslyAllowBrowser:!0});if(o===void 0)throw new u("API key is required for OpenRouter, define OPENROUTER_API_KEY in your environment or specifty the apiKey option.");return n.chat.completions.create(e)}};import $t from"openai";var Jt="perplexity/";async function*Gt(t){for await(let e of t)yield e}var Y=class extends g{async create(e){this.validateInputs(e);let o=this.opts.apiKey??process.env.PERPLEXITY_API_KEY;if(o===void 0)throw new u("API key is required for Perplexity, define PERPLEXITY_API_KEY in your environment or specifty the apiKey option.");let n=new $t({...this.opts,baseURL:"https://api.perplexity.ai",apiKey:o,dangerouslyAllowBrowser:!0}),s=e.model.replace(Jt,""),r=e.temperature===2?2-Number.EPSILON:e.temperature,a={...e,model:s,temperature:r};if(a.stream){let i=await n.chat.completions.create(a);return Gt(i)}else return n.chat.completions.create(a)}};var _e={openai:t=>new F(t,m.openai.models,m.openai.supportsJSON,m.openai.supportsImages,m.openai.supportsToolCalls,m.openai.supportsN,m.openai.supportsStreaming),anthropic:t=>new q(t,m.anthropic.models,m.anthropic.supportsJSON,m.anthropic.supportsImages,m.anthropic.supportsToolCalls,m.anthropic.supportsN,m.anthropic.supportsStreaming),gemini:t=>new D(t,m.gemini.models,m.gemini.supportsJSON,m.gemini.supportsImages,m.gemini.supportsToolCalls,m.gemini.supportsN,m.gemini.supportsStreaming),cohere:t=>new U(t,m.cohere.models,m.cohere.supportsJSON,m.cohere.supportsImages,m.cohere.supportsToolCalls,m.cohere.supportsN,m.cohere.supportsStreaming),bedrock:t=>new j(t,m.bedrock.models,m.bedrock.supportsJSON,m.bedrock.supportsImages,m.bedrock.supportsToolCalls,m.bedrock.supportsN,m.bedrock.supportsStreaming),mistral:t=>new J(t,m.mistral.models,m.mistral.supportsJSON,m.mistral.supportsImages,m.mistral.supportsToolCalls,m.mistral.supportsN,m.mistral.supportsStreaming),groq:t=>new $(t,m.groq.models,m.groq.supportsJSON,m.groq.supportsImages,m.groq.supportsToolCalls,m.groq.supportsN,m.groq.supportsStreaming),ai21:t=>new L(t,m.ai21.models,m.ai21.supportsJSON,m.ai21.supportsImages,m.ai21.supportsToolCalls,m.ai21.supportsN,m.ai21.supportsStreaming),perplexity:t=>new Y(t,m.perplexity.models,m.perplexity.supportsJSON,m.perplexity.supportsImages,m.perplexity.supportsToolCalls,m.perplexity.supportsN,m.perplexity.supportsStreaming),openrouter:t=>new W(t,m.openrouter.models,m.openrouter.supportsJSON,m.openrouter.supportsImages,m.openrouter.supportsToolCalls,m.openrouter.supportsN,m.openrouter.supportsStreaming),"openai-compatible":t=>new G(t,m.openrouter.models,m.openrouter.supportsJSON,m.openrouter.supportsImages,m.openrouter.supportsToolCalls,m.openrouter.supportsN,m.openrouter.supportsStreaming)},Pe=(t,e)=>{for(let o in _e)if(t===o)return _e[o](e);throw new Error("Could not find provider for model. Are you sure the model name is correct and the provider is supported?")},P=()=>Math.floor(new Date().getTime()/1e3),Yt=async t=>{let o=await(await fetch(t)).arrayBuffer();return btoa(String.fromCharCode.apply(null,new Uint8Array(o)))},Ht=t=>{let n=new URL(t).pathname.split(".").pop();return Wt(n)},zt=t=>{try{let e=new URL(t);return e.protocol==="http:"||e.protocol==="https:"}catch{return!1}},Xt=t=>/^data:image\/[a-zA-Z]+;base64,/.test(t),S=async t=>{if(zt(t)){let e=await Yt(t),o=Ht(t);if(o===null)throw new Error(`Failed to get the mime type for the URL: ${t}`);if(!Me(o))throw new u(`Unsupported MIME type: ${o}`);return{content:e,mimeType:o}}else{if(Xt(t))return Vt(t);throw new u("Invalid image URL.")}},Me=t=>t==="image/jpeg"||t==="image/png"||t==="image/gif"||t==="image/webp",Vt=t=>{let e=t.split(";base64,");if(e.length===2){let o=e[0].replace("data:","").toLowerCase();if(!Me(o))throw new u(`Unsupported MIME type: ${o}`);return{content:e[1],mimeType:o}}else throw new u("Invalid image URL.")},M=t=>{console.warn(Ft.yellow.bold(`Warning: ${t}
`))},pe=(t,e,o)=>["mistral","anthropic","cohere","bedrock"].includes(e)||e==="bedrock"&&(o.startsWith("amazon")||o.startsWith("anthropic")||o.startsWith("cohere")||o.startsWith("mistral")||o.startsWith("meta"))?t/2:t,ae=t=>t&&typeof t=="object"&&t.constructor===Object&&Object.keys(t).length===0;var _=t=>t?(typeof t=="string"?t:t.map(e=>e.text).join(`
`))??"":"";var oe=class{constructor(e){this.opts=e}create(e){return Pe(e.provider,this.opts).create(e)}},H=class{constructor(e){this.completions=new oe(e)}};var Te=class t{static{this.extendedModelList=[]}constructor({...e}={}){this.opts=e,this.chat=new H(e)}extendedModelExist(e,o){return t.extendedModelList.some(n=>n.provider===e&&n.name===o)}extendModelList(e,o,n){if(this.extendedModelExist(e,o))return this;if(Array.isArray(m[e].models)&&m[e].models.includes(o))throw new u(`You tried to add the following custom model name: "${o}", for provider: "${e}". But it conflicts with an existing pre-defined model name. Please try again using different name e.g.: "${o}-custom"`);let s=m[e];s.models=[...m[e].models,o];let r=(a,i)=>typeof a=="boolean"?a:a.includes(i);return typeof n=="string"?(r(s.supportsJSON,n)&&(s.supportsJSON=[...s.supportsJSON,o]),r(s.supportsStreaming,n)&&(s.supportsStreaming=[...s.supportsStreaming,o]),r(s.supportsImages,n)&&(s.supportsImages=[...s.supportsImages,o]),r(s.supportsToolCalls,n)&&(s.supportsToolCalls=[...s.supportsToolCalls,o])):(n.json&&(s.supportsJSON=[...s.supportsJSON,o]),n.streaming&&(s.supportsStreaming=[...s.supportsStreaming,o]),n.toolCalls&&(s.supportsToolCalls=[...s.supportsToolCalls,o]),n.images&&(s.supportsImages=[...s.supportsImages,o])),t.extendedModelList.push({provider:e,name:o,featureSupport:n}),this}};export{eo as TableDisplayNames,Te as TokenJS,m as models};
